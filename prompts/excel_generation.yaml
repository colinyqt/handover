name: "Excel Compliance Report - Direct Processing"
description: "Generate Excel compliance reports with direct LLM output processing"
version: "3.1"

inputs:
  - name: "analysis_file"
    type: "file"
    required: true
    formats: ["txt", "json"]
    description: "Tender analysis output file (text or JSON format)"
  
  - name: "selected_meter"
    type: "text"
    required: false
    description: "Override meter selection (leave blank to use analysis default)"

databases:
  meters: 'C:\Users\cyqt2\Database\overhaul\databases\meters.db'

processing_steps:
  - name: "create_excel_report"
    description: "Extract compliance data and create complete Excel structure in one step"
    prompt_template: |
      You are creating a complete Excel compliance report from a tender analysis file.

      ANALYSIS FILE CONTENT:
      {{ inputs.analysis_file.content }}

      TASK: Extract all compliance information and return the COMPLETE Excel structure ready for generation.

      You MUST return EXACTLY this JSON structure with all three sections populated:

      {
        "summary_sheet": {
          "title": "Compliance Summary",
          "data": {
            "project_name": "Tender Compliance Analysis",
            "selected_meter": "PM5320 (PM5000 Series)",
            "analysis_date": "{{ timestamp }}",
            "generated_by": "colinyqt",
            "overall_compliance": "78%",
            "total_requirements": 15,
            "status_breakdown": {
              "fully_compliant": 10,
              "partially_compliant": 3,
              "non_compliant": 2
            }
          }
        },
        "compliance_matrix": {
          "title": "Detailed Compliance Matrix",
          "headers": [
            "Clause ID", "Category", "Parameter", "Required", 
            "Meter Spec", "Status", "Justification", "Risk", "Comments"
          ],
          "data": [
            ["1.20.4", "Accuracy", "True RMS Current", "±0.5%", "±0.2%", "FULLY COMPLIANT", "Meter exceeds requirement", "Low", "Excellent accuracy"],
            ["1.20.4", "Accuracy", "True RMS Volts", "±0.5%", "±0.2%", "FULLY COMPLIANT", "Meter exceeds requirement", "Low", "Excellent accuracy"],
            ["1.20.4", "Accuracy", "Real Power", "±0.5%", "±0.2%", "FULLY COMPLIANT", "Meter exceeds requirement", "Low", "Excellent accuracy"],
            ["1.20.5", "Communication", "Interface", "RS485, RJ45", "RS485, Modbus TCP/IP", "PARTIALLY COMPLIANT", "Missing RJ45", "Medium", "Additional config needed"],
            ["1.20.6", "Environmental", "Protection", "IP2X", "IP54", "NON-COMPLIANT", "Protection mismatch", "High", "Environmental risk"]
          ]
        },
        "meter_specs": {
          "title": "Selected Meter Specifications",
          "meter_details": {
            "model": "PM5320",
            "series": "PM5000 Series",
            "selection_source": "Analysis recommendation",
            "specifications": {
              "accuracy": "±0.2%",
              "communication": "RS485, Modbus TCP/IP",
              "environmental": "IP54",
              "power_measurement": "All standard parameters"
            }
          }
        }
      }

      Extract real data from the analysis file to replace the example values above.
      CRITICAL: Return ONLY the JSON structure. No explanations, no markdown, no additional text.
    timeout: 300

outputs:
  # RAW LLM output for debugging
  - type: "text"
    filename: "raw_llm_output_{{ timestamp }}.txt"
    content: "{{ step_results.create_excel_report.raw_response }}"

  # CUSTOM Excel generation that handles raw LLM response
  - type: "custom_excel"
    filename: "{{ inputs.analysis_file.basename }}_compliance_report_{{ timestamp }}.xlsx"
    llm_step: "create_excel_report"

  # Simple status report
  - type: "text"
    filename: "{{ inputs.analysis_file.basename }}_status_{{ timestamp }}.txt"
    content: |
      ================================================================================
      EXCEL GENERATION STATUS
      ================================================================================
      
      Generated: {{ timestamp }}
      Source: {{ inputs.analysis_file.name }}
      Generated By: colinyqt
      
      ================================================================================
      LLM PROCESSING
      ================================================================================
      
      LLM Response Length: {{ step_results.create_excel_report.raw_response | length if step_results.create_excel_report.raw_response else 0 }} characters
      
      LLM Success: {% if step_results.create_excel_report.success %}✅ YES{% else %}❌ NO{% endif %}
      
      {% if step_results.create_excel_report.raw_response %}
      First 500 characters of LLM response:
      {{ step_results.create_excel_report.raw_response[:500] }}...
      {% endif %}
      
      ================================================================================
      EXPECTED OUTPUT
      ================================================================================
      
      Excel File: {{ inputs.analysis_file.basename }}_compliance_report_{{ timestamp }}.xlsx
      
      ================================================================================
      END OF STATUS
      ================================================================================